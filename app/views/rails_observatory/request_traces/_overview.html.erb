<%
  sql_events = @events.only('sql.active_record').to_a
  sql_total_ms = sql_events.sum { |e| e['duration'] }.round(2)

  view_events = @events.only('render_template.action_view', 'render_partial.action_view', 'render_layout.action_view').to_a
  view_total_ms = view_events.sum { |e| e['duration'] }.round(2)

  cache_events = @events.only('call.redis').to_a

  start_event = @events.only('start_processing.action_controller').first
  request_params = start_event&.dig('payload', 'params') || {}
  request_headers = start_event&.dig('payload', 'request', 'headers') || {}

  process_action_event = @events.only('process_action.action_controller').first
  response_headers = process_action_event&.dig('payload', 'response', 'headers') || {}

  unpermitted_events = @events.only('unpermitted_parameters.action_controller').to_a
  controller = start_event&.dig('payload', 'controller')
  action = start_event&.dig('payload', 'action')
  unpermitted_keys = unpermitted_events
    .select { |e|
      e.dig('payload', 'context', 'controller') == controller &&
      e.dig('payload', 'context', 'action') == action
    }
    .flat_map { |e| e.dig('payload', 'keys') || [] }
    .map { |k| k.is_a?(Array) ? k.join('.') : k.to_s }
    .to_set

  rate_limit_events = @events.only('rate_limit.action_controller').to_a
%>

<div class="tab-content overview layout-two-column">
  <div class="layout-two-column-main">
    <% if rate_limit_events.any? %>
      <section class="rate-limit-section" style="margin-bottom: var(--sp-6); padding: var(--sp-4); background: var(--error-bg, #fef2f2); border: 1px solid var(--error-border, #fecaca); border-radius: var(--border-radius);">
        <h3 style="margin-bottom: var(--sp-3); color: var(--error, #dc2626); margin-top: 0; display: flex; align-items: center; gap: var(--sp-2);">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
          </svg>
          Request Rejected (Rate Limited)
        </h3>
        <p style="margin: 0 0 var(--sp-3) 0; color: var(--black-secondary);">
          This request exceeded the rate limit and was blocked with a 429 response.
        </p>
        <% rate_limit_events.each do |event| %>
          <% payload = event['payload'] || {} %>
          <dl style="display: grid; grid-template-columns: max-content 1fr; gap: var(--sp-2) var(--sp-4); margin: 0;">
            <% if payload['name'].present? %>
              <dt style="color: var(--black-secondary);">Limit Name</dt>
              <dd style="margin: 0; font-weight: 500;"><%= payload['name'] %></dd>
            <% end %>
            <% if payload['count'] && payload['to'] %>
              <dt style="color: var(--black-secondary);">Requests Made</dt>
              <dd style="margin: 0;">
                <span style="color: var(--error, #dc2626); font-weight: 500;"><%= payload['count'] %></span>
                <span style="color: var(--black-secondary);">(limit: <%= payload['to'] %>)</span>
              </dd>
            <% end %>
            <% if payload['within'].present? %>
              <dt style="color: var(--black-secondary);">Time Window</dt>
              <dd style="margin: 0;"><%= distance_of_time_in_words(payload['within']) %></dd>
            <% end %>
            <% if payload['by'].present? %>
              <dt style="color: var(--black-secondary);">Limited By</dt>
              <dd style="margin: 0; font-family: var(--font-mono); font-size: 0.9em;"><%= payload['by'] %></dd>
            <% end %>
            <% if payload['scope'].present? %>
              <dt style="color: var(--black-secondary);">Scope</dt>
              <dd style="margin: 0;"><%= payload['scope'] %></dd>
            <% end %>
          </dl>
        <% end %>
      </section>
    <% end %>

    <section>
      <h3 style="margin-bottom: var(--sp-3); color: var(--black-secondary); margin-top:0;">Parameters</h3>
      <% flattened_params = flatten_params(request_params) %>
      <% if flattened_params.any? %>
        <dl style="display: grid; grid-template-columns: max-content 1fr; gap: var(--sp-2) var(--sp-4);">
          <% flattened_params.each do |key, value| %>
            <% is_unpermitted = key.split('.').any? { |part| unpermitted_keys.include?(part) } %>
            <dt style="color: <%= is_unpermitted ? 'var(--error)' : 'var(--black-secondary)' %>;"><%= key %></dt>
            <dd style="margin: 0;<%= ' color: var(--error);' if is_unpermitted %>"><%= value.is_a?(Array) ? value.to_json : value %></dd>
          <% end %>
        </dl>
      <% else %>
        <p style="color: var(--black-secondary);">No parameters</p>
      <% end %>
    </section>

    <details style="margin-top: var(--sp-6);">
      <summary style="cursor: pointer; display: flex; align-items: center; gap: var(--sp-2);">
        <svg class="arrow-right" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
        Request Headers (<%= request_headers.size %>)
      </summary>
      <div style="margin-top: var(--sp-3);">
        <% if request_headers.any? %>
          <dl style="display: grid; grid-template-columns: max-content 1fr; gap: var(--sp-2) var(--sp-4);">
            <% request_headers.sort.each do |key, value| %>
              <dt style="color: var(--black-secondary);"><%= key %></dt>
              <dd style="margin: 0; word-break: break-all;"><%= value %></dd>
            <% end %>
          </dl>
        <% else %>
          <p style="color: var(--black-secondary);">No headers captured</p>
        <% end %>
      </div>
    </details>

    <details style="margin-top: var(--sp-6);">
      <summary style="cursor: pointer; display: flex; align-items: center; gap: var(--sp-2);">
        <svg class="arrow-right" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
        Response Headers (<%= response_headers.size %>)
      </summary>
      <div style="margin-top: var(--sp-3);">
        <% if response_headers.any? %>
          <dl style="display: grid; grid-template-columns: max-content 1fr; gap: var(--sp-2) var(--sp-4);">
            <% response_headers.sort.each do |key, value| %>
              <dt style="color: var(--black-secondary);"><%= key %></dt>
              <dd style="margin: 0; word-break: break-all;"><%= value %></dd>
            <% end %>
          </dl>
        <% else %>
          <p style="color: var(--black-secondary);">No headers captured</p>
        <% end %>
      </div>
    </details>
  </div>

  <div class="layout-two-column-side-panel side-panel">
    <dl>
      <% if rate_limit_events.any? %>
        <dt style="color: var(--error, #dc2626);">Rate Limited</dt>
        <dd style="color: var(--error, #dc2626); font-weight: 500;">
          Blocked (429)
        </dd>
      <% end %>
      <dt>Duration</dt>
      <dd><%= @trace.duration.round(2) %> ms</dd>
      <dt>Events</dt>
      <dd><%= @events.size %></dd>
      <dt>SQL Queries</dt>
      <dd><%= sql_events.size %> (<%= sql_total_ms %> ms)</dd>
      <dt>Views</dt>
      <dd><%= view_events.size %> (<%= view_total_ms %> ms)</dd>
      <dt>Cache/Redis</dt>
      <dd><%= cache_events.size %> calls</dd>
      <dt>Allocations</dt>
      <dd><%= number_with_delimiter(@trace.allocations) %></dd>
    </dl>
  </div>
</div>
